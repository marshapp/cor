\documentclass[11pt]{article}
\usepackage{graphicx} % Required for inserting images
\usepackage[top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm]{geometry}
\usepackage[T1]{fontenc}
\usepackage{hyperref}
\usepackage[utf8]{inputenc}
\usepackage{multirow}
\usepackage{subcaption}
\usepackage{booktabs}
\usepackage{bookmark}
\usepackage{graphicx}
\usepackage{setspace}
\setlength{\parindent}{0in}
\usepackage{physics}
\usepackage{tikz}
\usepackage{tikz-3dplot}
\usepackage[outline]{contour} % glow around text
\usepackage{xcolor}
\usepackage{float}
\usepackage{makeidx}
\usepackage{fancyhdr}
\usepackage{pgfplots}
\usepackage{amsmath}
\pgfplotsset{compat=1.18}
\usepackage{caption}
\usepackage[english,catalan]{babel}
\setlength{\parskip}{11pt}
\usepackage{xcolor}
\usepackage{listings}


\title{\Huge\bfseries Cor:Cor \\[1ex] \Large}

\author{\begin{tabular}{c}
\textbf{GRUP C3} \\
Isaac Baldi\\
Marcel López Freixes (1668323) \\
Eira Jacas García (1666616) \\
Núria Castillo Ariño (1669145)
\end{tabular}}

\date{data}

\begin{document}

\maketitle

\section{Introducció}


En aquesta pràctica hem solucionat numèricament l'equació de difusió de la calor amb una font d'energia externa. El problema es contextualitza en l'ablació cardíaca, que es una cirurgia simple que es basa en escalfar el teixit biològic entre els ventricles del cor amb dos elèctrodes de polaritats oposades. Les condicions perquè el mètode sigui efectiu són que cap regió pot sobrepassar els 80ºC i que la regió de teixit sa no superi els 50ºC, temperatura a la qual comença la mort cel·lular. Nosaltres ens proposem trobar el temps màxim que podem aplicar un potencial de 40V entre els elèctrodes sense trencar aquestes condicions. Per fer-ho provarem tres mètodes numèrics diferents: Euler explícit, Euler implícit i Crank-Nicolson i en compararem els errors per decidir quin es millor per solucionar el problema.

\begin{equation}
    c_v \rho \frac{\partial T}{\partial t} = \nabla \cdot (\kappa \nabla T) + P_{\text{ext}}
\label{eq: eq_inicial}
\end{equation}


Si simplifiquem el sistema un espai cilíndricament simètric, ens queda


\begin{equation}
    c_v \rho \frac{\partial T}{\partial t} = \frac{\partial^2 T}{\partial x^2} + P_{\text{ext}}
\label{eq: eq_inicial_cilindriques}
\end{equation}
\section{normalització}

Dividint l'eq. \eqref{eq: eq_inicial_cilindriques} per $c_v\rho$ i definint $\lambda=\frac{P_ext}{\rho c_v}$, queda

\begin{equation}
    \frac{\partial T}{\partial t} = \alpha \frac{\partial^2 T}{\partial x^2} + \lambda \implies \frac{1}{\lambda}\frac{\partial T}{\partial t} = \frac{\alpha}{\lambda} \frac{\partial^2 T}{\partial x^2} + 1
\label{eq: eq_entre_rhocv}
\end{equation}

on $\alpha=\frac{k}{\rho c_v}$ és la difusivitat tèrmica.

Si definim $\hat{x}=\frac{x}{L}$, $\hat{T}=T \frac{\alpha}{\lambda L^2}$ i $\hat{t}=t\frac{\alpha}{L^2}$, aleshores

\begin{equation}
    \frac{\partial \hat{T}}{\partial \hat{t}} = \frac{\partial^2 \hat{T}}{\partial \hat{x}^2} + 1
\label{eq: eq_normalitzada}
\end{equation}

\section{Solució analítica}


Seguint la solució de proposada a l'annex del guió amb $q(x,t)=1$ i $\beta=\hat{T}(T_c)$, queda que



\begin{equation}
    f(\hat{x}, \hat{t}) = \beta + \frac{4}{\pi^3} \sum_{n=1}^{\infty} \frac{1 - e^{-(2n-1)^2 \pi^2 \hat{t}}}{(2n-1)^3} \sin\big((2n-1)\pi \hat{x})
\label{eq: analitica}
\end{equation}


\section{Solucio numèrica: Euler explicit}

Per aplicar el mètode numèric d'euler explicit

\begin{equation}
    \frac{\partial \hat{T}}{\partial \hat{t}} = \frac{\hat{T}_j^{n+1} - \hat{T}_j^n}{\Delta \hat{t}} \ .
    \label{derivada per la dreta}
\end{equation}

\begin{equation}
    \frac{\delta^2 \hat{T}}{\delta \hat{z}^2} = \frac{\hat{T}_{j+1}^n - 2\hat{T}_{j}^n + \hat{T}_{j-1}^n}{\Delta \hat{z}^2}
    \label{2a derivada espaial}
\end{equation}

\section{Euler implícit}
En aquest mètode la derivada espacial de l'Eq. \eqref{eq: eq_normalitzada} es calcula de la mateixa manera que en l'explícit, és a dir, a partir de l'Eq. \eqref{2a derivada espaial}. La diferència recau en el càlcul de la derivada temporal: mentre que en el mètode explícit s'utilitza l'aproximació de la derivada per la dreta, en l'implícit s'aplica l'aproximació per l'esquerra. Aquesta última ve donada per l'expressió següent:
\begin{equation}
    \frac{\partial \hat{T}}{\partial \hat{t}} = \frac{\hat{T}_j^n - \hat{T}_j^{n-1}}{\Delta \hat{t}} \ .
    \label{derivada per lesquerra}
\end{equation}

Substituint les aproximacions de les derivades corresponentment a l'equació diferencial i aïllant $\hat{T}_j^n$, s'obté:
\begin{equation}
    \hat{T}_j^n = \frac{\gamma \left( \hat{T}_{j+1}^n + \hat{T}_{j-1}^n \right) + \hat{T}_j^{n-1} + \Delta \hat{t}}{1 + 2\gamma}
    \label{Tnj implicit} \ .
\end{equation}

A la part dreta de la igualtat apareixen temperatures en el pas temporal $n$. Per tant, no és possible aïllar $\hat{T}_j^n$ en funció de temperatures únicament en temps anteriors.  Així doncs, efectivament l'equació és implícita. 

Per les condicions inicials i de contorn, les temperatures en $j=1$, $j=N$ i $n=1$ no són variables sinó valors ja coneguts. Concretament, $\hat{T}_j^1=\hat{T}_1^n=\hat{T}_N^n = \beta$. Així doncs, per a $j=2$ i $j=N-1$ cal utilitzar expressions modificades:
\begin{align}
    \hat{T}_2^n = \frac{\gamma \hat{T}_3^n + \beta(\gamma+1)+\Delta\hat{t}}{2\gamma+1} \ ; \label{T_2^n implicit} \\
    \hat{T}_{N-1}^n = \frac{\gamma \hat{T}_{N-2}^n + \beta(\gamma+1)+\Delta\hat{t}}{2\gamma+1} \ . \label{T_N-1^n implicit}
\end{align}

La resolució numèrica d'aquest problema es planteja com un sistema d'equacions algebraiques que cal resoldre iterativament en cada pas temporal $n$. Partint de les condicions inicials, es resol successivament per obtenir les temperatures dels passos següents de forma recursiva, aprofitant que els valors de $\hat{T}_j^{n-1}$ són coneguts del pas anterior.

El sistema es pot expressar en forma matricial per a cada pas $n$. Per resoldre'l, utilitzem el mètode iteratiu de Gauss-Seidel.

\section{Solució numèrica: mètode Crank-Nicolson}

En aquest mètode numèric la discretització de la derivada temporal s'aproxima com en el mètode d'Euler explícit, l'Eq. \eqref{eq: derivada per la dreta}. En canvi, la segona derivada espacial com la mitjana de les dues posicions considerades a la discretització de la derivada temporal:

\begin{equation}
    \frac{\partial^2\hat{T}}{\partial \hat{x^2}} = \frac{1}{2}\frac{\hat{T}_{j+1}^n-2\hat{T}_{j}^n+\hat{T}_{j-1}^n}{\delta x}^2
    \label{mitjana segones derivades espacials}
\end{equation}

I ens acaba resultat l'expressió següent:
\begin{equation}
    \a
    \label{}
\end{equation}

La resolució d'aquest problema també es planteja com un sistema d'equacions algebraiques, una per cada pas espacial, que cal resoldre iterativament per cada pas temporal $\hat{T}_j^n$. Com en el mètode d'Euler implícit, es parteix de les condicions inicials i es resol successivament per obtenir les temperatures dels passos següents de forma recursiva, aprofitant que els valors de $\hat{T}_j^{n-1}$ són coneguts del pas anterior.

El sistema es pot expressar en forma matricial per a cada pas $\hat{T}_j^n$, i per resoldre'l, utilitzem el mètode iteratiu de Jacobi.

\begin{equation}
  \begin{pmatrix}
    (\gamma - {1}) & {-}\frac{\gamma}{2} & {0} & {0} & \cdots & {0} \\
    {-}\frac{\gamma}{2} & (\gamma - {1}) & {-}\frac{\gamma}{2} & {0} & \cdots & {0} \\
    & \\
    \vdots & \vdots & & \ddots & & \vdots \\
    & \\
    {0} & {0} & \cdots & {-}\frac{\gamma}{2} & (\gamma - {1}) & {-}\frac{\gamma}{2} \\
    {0} & {0} & \cdots & {0} & {-}\frac{\gamma}{2} & (\gamma - {1}) \\
    \end{pmatrix}
    \begin{pmatrix}
        \hat{T}_{j=1}^{n+1} \\
        \hat{T}_{j=2}^{n+1} \\
        \vdots \\
        \hat{T}_{j=N-2}^{n+1} \\
        \hat{T}_{j=N-1}^{n+1} \\
    \end{pmatrix}
    =
    \begin{pmatrix}
        f_{j=1} +\frac{\gamma}{2}\hat{T}_{c} \\
        f_{j=2} \\
        \vdots \\
        f_{j=N-2} \\
        f_{j=N-1} +\frac{\gamma}{2}\hat{T}_{c} \\
    \end{pmatrix}
\end{equation}

on $f = \frac{\gamma}{2}\hat{T}_{j+1}^{n} + (\gamma - {1})\hat{T}_{j}^{n} + \frac{\gamma}{2}\hat{T}_{j-1}^{n} + \Delta\hat{t}$

Per veure l'eficiència d'aquest mètode, compararem la solució analítica i la numèrica per a cada pas del 
mallat espacial per al temps $t_a = 0.025$ especificada en l'enunciat. Calculem l'error absolut entre les 
temperatures, que també ens servirà per comparar amb els altres dos mètodes numèrics que hem utilitzat.

\begin{figure}[hbt!]
    \centering
    \begin{subfigure}{0.3\textwidth}
        \centering
        \includegraphics[width=\textwidth]{errcranc3gamma.png}
        \caption{error numèric de Crank-Nicolson per diferents mallats}
    \end{subfigure}%
    \hspace{0.01\textwidth}%
    \begin{subfigure}{0.3\textwidth}
        \centering
        \includegraphics[width=\textwidth]{errtemp3met.png}
        \caption{error dels 3 mètodes numèrics utilitzats per un mateix mallat}
    \end{subfigure}
    \hspace{0.01\textwidth}

    \caption{Gràfics Error numèric Crank Nicolson.}
    \label{fig:dues_imatges}
\end{figure}
!!!!FALTA INCLOURE ERROR IMPLICIT, GP FET FALTA TENIR LES DADES EN TXT

Observant el gràfic de l'esquerra podem veure que l'error augmenta com més ens allunyem dels límits de l'interval espacial però que si ens aproximem al centre torna a disminuir. 
També podem observar que si reduim el tamany de l'interval del mallat, l'error es fa més petit. 
Això és perquè estem fent passos més petits en la discretització del temps. 
Al reduir el tamany dels passos ens apropem cada vegada més a la definició de diferencial i,per tant, l'equació discretitzada s'aproxima millor a l'equació diferencial que volem resoldre.

D'altra banda gràfics de la dreta, notem que la diferència de temperatura que presenta la solució numèrica de Crank és més gran que la que presenten els altres mètodes numèrics (Euler explícit i Euler implícit). 
La diferència entre el mètodes numèrics és el tipus de discretització que fem per a les derivades de l'equació diferencial. Així doncs, veiem que per aquest problema i per aquest interval d'espai i temps, aproximar la derivada segona com la mitjana de ens porta a una solució que s'allunya més de la solució analítica. 
Això podria ser perquè...SEGUIR

\section{Millora del model}




\section{Animació}
Un cop teniem els mètodes implementats hem representat els resultats amb un gif on es pot veure l'evolució del camp de temperatura en dues dimencions al llarg del temps. El nostre problema només depèn d'una dimenció espaial però per fer el gif més representatiu del sistema d'electrodes que narra el problema, hem extès el camp de temperatures a una segona dimenció espaial. 
Per generara el gif primer hem calculat el camp de temperatures en 100 temps equiespaiats i hem convertit aquestes dades en 100 fitxers txt. En segon lloc, hem plotejat les dades d'aquests fitxers amb una rutina de gnuplot obtenint 100 fotogrames. Per últim amb el programa ImageMagick hem seqüenciat els fotogrames per generar el gif.
En el gif veiem clarament com en els extrems dret i esquerra del camp, on hi hauria els electrodes, la temperatura es manté a la temperatura corporal i, en canvi, al mig, on hi hauria el teixit malalt, la temperatura va augmentant amb el temps.



\begin{figure}[hbt!]
    \centering
    \begin{subfigure}{0.3\textwidth}
        \centering
        \includegraphics[width=\textwidth]{frame_000.png}
        \caption{frame 1}
    \end{subfigure}
    \hspace{0.01\textwidth}
    \begin{subfigure}{0.3\textwidth}
        \centering
        \includegraphics[width=\textwidth]{frame_050.png}
        \caption{frame 50}
    \end{subfigure}
    \hspace{0.01\textwidth}
    \begin{subfigure}{0.3\textwidth}
        \centering
        \includegraphics[width=\textwidth]{frame_100.png}
        \caption{frame 100}
    \end{subfigure}

    \caption{Tres frames representatius del gif.}
    \label{fig:dues_imatges}
\end{figure}

Link per a accedir al gif penjat a youtube: \url{https://youtu.be/GGSp-ycK4H0}

\end{document}

\end{document}